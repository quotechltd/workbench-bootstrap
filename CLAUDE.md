# Claude AI Agent - First Point of Contact

## Project Structure

This workspace contains two main projects:

- **backend/** - Go-based backend service
- **frontend/** - React/TypeScript frontend application

## Backend (`/Users/williamhunt/workbench/backend`)

### Key Files
- `README.md` - Project documentation
- `CLAUDE.md` - Backend-specific AI agent documentation
- `go.mod` / `go.sum` - Go module dependencies
- `Taskfile.yaml` - Task automation configuration
- `docker-compose.yaml` - Docker services configuration
- `sqlc.yaml` - SQL code generation configuration

### Important Documentation
- `AUTHORIZATION_SYSTEM.md` - Authorization system details
- `AUTHZ_ISSUES.md` - Known authorization issues
- `MODULE_MIGRATION_PLAN.md` - Module migration planning
- `REFACTOR_PLAN_REMAINING_MODULES.md` - Refactoring plans
- `PR_CLEANUP_CHECKLIST.md` - PR checklist

### Key Directories
- `internal/` - Internal application code
- `cmd/` - Command-line applications
- `migrations/` - Database migrations
- `test/` - Test files
- `docs/` - Additional documentation

### Important Routes
- User management is consolidated at `/users/:userId` and `/users/me` (frontend)
- Backend user endpoints: `/api/v0/settings/users/:userId` and `/api/v0/authz/users/me`

## Frontend (`/Users/williamhunt/workbench/frontend`)

### Key Files
- `README.md` - Project documentation
- `CLAUDE.md` - Frontend-specific AI agent documentation
- `package.json` - Node.js dependencies and scripts
- `yarn.lock` - Yarn dependency lock file
- `vite.config.ts` - Vite build configuration
- `tsconfig.json` - TypeScript configuration
- `.env` / `.env.example` - Environment variables

### Important Documentation
- `CYPRESS.md` - Cypress testing documentation

### Key Directories
- `src/` - Source code
- `public/` - Static assets
- `cypress/` - E2E tests
- `dist/` - Build output
- `docs/` - Additional documentation

### Testing
- `cypress.config.ts` - Cypress configuration
- `cypress/` - Cypress test files

## Git Workflow

Both projects use Git for version control:
- Backend: Currently on `main` branch
- Frontend: Currently on `main` branch

## Important Notes

- Always ensure both projects are on the correct branch before making changes
- Pull latest changes from main before starting work
- Check git status regularly to track changes
- Each project has its own `CLAUDE.md` file with project-specific information

## Essential Commands

**Backend:**
```bash
task generate      # Generate code (sqlc, jet, OpenAPI)
task fmt          # Run Go fmt and sqlfluff
task lint         # Run linters (golangci-lint, deadcode, sqlfluff)
task test         # Run tests (use PATTERN=... for specific tests)
task build        # Build the application
task watch        # Start with live reload
```

**Frontend:**
```bash
npm run dev       # Start dev server (http://localhost:5174)
npm run lint      # Run ESLint checks - ALWAYS run before completing tasks
npm run build     # Production build
npm run cy:open   # Open Cypress test runner
npm run cy:run    # Run Cypress tests headlessly
```

## Backend Guidelines

### Migration Management

**Creating Migrations:**
- Use `task create-migration NAME=descriptive_name` to create new migrations
- Always check for migration number conflicts after rebasing from main
- Migration numbers must be unique - if a conflict exists, renumber yours to the next available number
- Use `ls -1 migrations/ | grep "^000XX"` to check for duplicates (replace XX with your number prefix)

**Migration Content:**
- Use descriptive names that clearly indicate what the migration does (e.g., `add_currency_table`, `rename_binding_authorities`)
- Always create both `.up.sql` and `.down.sql` files
- Follow sqlfluff formatting rules (will be checked by `task fmt`)

### Code Generation

**Order of Operations:**
1. After SQL changes: run `task generate` to regenerate sqlc/jet models
2. After OpenAPI changes: run `task generate` to regenerate API code
3. Always run `go fmt ./...` after generation
4. Run `task lint` to catch any issues before committing

**Generated Files:**
- Never manually edit generated files (files with comments like "Code generated by...")
- If generated code is wrong, fix the source (SQL queries, OpenAPI spec, etc.) and regenerate
- Generated files should be committed after regeneration

### SQL Best Practices

- **ALWAYS** use `sqlc.narg()` without exception for params
- **NEVER** use SQL keywords as identifiers in queries
- Always run `go fmt ./...` for any Go code changes
- If edited or adding SQL, always run `sqlfluff fix` after
- Before concluding any work, run `task generate` and `task lint` to catch errors
- Run tests with `task test` - for specific tests use `task test PATTERN=...`
- Do NOT truncate test output with head or tail
- Always run `go fmt ./...` after concluding any work

### Testing
- Run `task test` to run all tests
- Use `task test PATTERN=<regex>` to run specific tests or patterns
- Set `LOG_LEVEL=<level>` for verbosity control (default: ERROR)
- Never truncate test output with head or tail

## Frontend Guidelines

### Technology Stack
- **Framework**: React 18.2.0 with TypeScript
- **Build Tool**: Vite 6.0.11
- **UI Library**: Mantine UI v7
- **Routing**: React Router DOM v6
- **State Management**: React Context API, SWR for data fetching
- **Forms**: React Final Form (ALWAYS use for ALL forms)
- **Auth**: Zitadel OAuth/OIDC
- **Testing**: Cypress (E2E and component)

### Component Structure Pattern

ALWAYS follow this import order and structure:

```tsx
// 1. React imports
import { useState, useEffect, useMemo } from 'react';

// 2. Third-party imports
import { Button, Group, Stack, Text } from '@mantine/core';
import { notifications } from '@mantine/notifications';

// 3. Local imports - utilities
import { handleApiCall } from '@/shared/utils/api/handleApiCall';

// 4. Local imports - types
import type { Risk } from '../types';

// 5. Local imports - services/hooks/components
import { getRisks } from '../services/risk';

// Component definition
export function ComponentName() {
  // Hooks first
  // State
  // Effects
  // Handlers
  // Render
}
```

### Form Handling

**ALWAYS use React Final Form for ALL forms - no exceptions:**

```tsx
import { Form, Field } from 'react-final-form';
import { FORM_ERROR } from 'final-form';

<Form
  onSubmit={handleSubmit}
  initialValues={initialData}
  render={({ handleSubmit, submitting, submitError }) => (
    <form onSubmit={handleSubmit}>
      {submitError && <Alert color="red">{submitError}</Alert>}
      <Field name="amount">
        {({ input, meta }) => (
          <TextInput {...input} error={meta.touched && meta.error} />
        )}
      </Field>
    </form>
  )}
/>

// Handle errors by returning FORM_ERROR
const handleSubmit = async (values) => {
  try {
    await submitData(values);
  } catch (error) {
    return { [FORM_ERROR]: error.message };
  }
};
```

### API Service Pattern

```typescript
import { handleApiCall } from '@/shared/utils/api/handleApiCall';
import { axiosInstance } from '@/shared/utils/api/axiosInstance';

export async function getResources(accessToken: string) {
  return handleApiCall(
    () => axiosInstance.get('/api/resources', {
      headers: { Authorization: `Bearer ${accessToken}` }
    }),
    'Failed to fetch resources'
  );
}
```

### Code Style Rules

- **NO** console.logs in production code
- **NO** commented-out code
- **NO** unused imports or variables
- **ALWAYS** handle loading and error states
- **ALWAYS** include proper TypeScript types (avoid `any`)
- **PREFER** composition over inheritance
- **PREFER** functional components over class components
- Use Mantine's spacing scale (xs, sm, md, lg, xl)
- Use theme colors (blue, gray, red, green, yellow)

### Error Handling

```typescript
try {
  const result = await apiCall();
  notifications.show({
    title: 'Success',
    message: 'Operation completed',
    color: 'green'
  });
} catch (error) {
  notifications.show({
    title: 'Error',
    message: error.message || 'Operation failed',
    color: 'red'
  });
}
```

## Issue Creation Guidelines

**When Creating GitHub Issues:**
- **DO NOT search the codebase** - only use information provided in the user's prompt
- **ONLY include known facts about the issue** - observations, error messages, reproduction steps provided by user
- **DO NOT include proposed solutions** - let the team discuss solutions in the issue
- **DO NOT include multiple solution options** - this biases the discussion
- **DO NOT investigate root causes** - just report what the user told you
- Keep descriptions focused and concise
- Only include file paths/line numbers if the user provided them
- Include code snippets only if the user provided them
- Include impact on users/system if the user mentioned it

**Good Issue Example:**
```
## Problem
Users cannot view risks without having the settings module assigned.

## Observations
- Users need settings module and settings:users view permission to see risks when selecting one
- Workaround in use: giving users settings module access
```

**Bad Issue Examples:**
```
# Bad: Searching codebase for root cause
Found the issue in internal/risque/service/risque.go:222...

# Bad: Proposing solutions
## Proposed Solutions
### Option 1: Remove authorization check (Recommended)
### Option 2: Create internal method

# Bad: Adding technical details not provided by user
The authorization system checks module access at line 203...
```

## Git Commit Guidelines

**Commit Messages:**
- DO NOT add "Generated with Claude Code" or "Co-Authored-By: Claude" footers
- Write clear, concise commit messages in imperative mood (e.g., "Add feature" not "Added feature")
- Focus on what and why, not how
- Use conventional commit prefixes: `feat:`, `fix:`, `refactor:`, `chore:`, `docs:`, `test:`

**Commit Workflow:**
- Only commit when explicitly asked by the user
- Backend: Run `task generate` and `task lint` before committing to catch errors
- Backend: Always run `go fmt ./...` before committing Go code changes
- Frontend: Run `npm run lint` before committing
- Never use `--no-verify` or skip git hooks unless explicitly requested
- Never amend commits unless explicitly requested
- Never force push to main/master

**Pull Requests:**
- DO NOT add "Generated with Claude Code" footers to PR descriptions
- DO NOT include test plans or testing checklists in PR descriptions
- Keep PR descriptions clear, concise, and focused on what changed and why
- Avoid unnecessary sections or verbose explanations
- Use `gh` CLI for GitHub operations

## Pre-Work Checklist

Before starting any task:
1. Ensure you're on the correct branch and up to date with main
2. Read relevant documentation files in the project
3. Understand the module structure and existing patterns

## Pre-Commit Checklist

**Backend:**
1. Run `task generate` if SQL or OpenAPI changes were made
2. Run `go fmt ./...`
3. Run `task lint`
4. Run `task test` (with PATTERN if needed)
5. Verify generated files are committed

**Frontend:**
1. Run `npm run lint`
2. Verify no console.logs or commented code
3. Verify all imports are used
4. Run Cypress tests if UI changes were made

**Both:**
1. Review git diff to ensure only intended changes are included
2. Write clear, concise commit message
3. Commit without skipping hooks
